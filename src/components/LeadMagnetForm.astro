---
const {
  title = "Get the free mini-guide",
  text = "3 quick tips to reduce facial tension and support a more open look.",
} = Astro.props;
---

<div class="leadmagnet">
  <div class="leadmagnet__copy">
    <h3 class="h3">{title}</h3>
    <p class="muted">{text}</p>
  </div>

  <form class="leadmagnet__form" id="lead-form" novalidate>
    <label class="field">
      <span class="field__label">Email</span>
      <input
        class="input"
        type="email"
        name="email"
        autocomplete="email"
        inputmode="email"
        placeholder="you@example.com"
        required
      />
    </label>

    <label class="field">
      <span class="field__label">Name (optional)</span>
      <input
        class="input"
        type="text"
        name="name"
        autocomplete="name"
        placeholder="Alina"
      />
    </label>

    <label class="check">
      <input class="check__input" type="checkbox" name="consent" required />
      <span class="check__text">
        I agree to receive emails with the free guide and occasional tips. I can
        unsubscribe anytime.
      </span>
    </label>

    <!-- Honeypot -->
    <input class="hp" type="text" name="company" tabindex="-1" autocomplete="off" />

    <button
      class="btn btn--primary"
      type="submit"
      data-ff-event="lead_magnet_submit"
      data-ff-content="free_tips"
    >
      Get the guide
    </button>

    <p class="status" id="lead-status" aria-live="polite"></p>
  </form>
</div>

<script>
  const form = document.getElementById("lead-form");
  const status = document.getElementById("lead-status");

  function setStatus(message, type = "info") {
    status.textContent = message || "";
    status.dataset.type = type;
  }

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();
    setStatus("");

    const fd = new FormData(form);
    const email = (fd.get("email") || "").toString().trim().toLowerCase();
    const name = (fd.get("name") || "").toString().trim();
    const consent = Boolean(fd.get("consent"));
    const company = (fd.get("company") || "").toString().trim(); // honeypot

    // let bots “succeed” silently
    if (company) {
      window.location.href = "/thanks";
      return;
    }

    if (!email || !email.includes("@")) {
      setStatus("Please enter a valid email.", "error");
      return;
    }
    if (!consent) {
      setStatus("Please confirm email consent (checkbox).", "error");
      return;
    }

    try {
      setStatus("Submitting…", "info");

      const res = await fetch("/api/subscribe", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ email, name, consent, company }),
      });

      const json = await res.json().catch(() => null);

      if (!res.ok || !json?.ok) {
        setStatus("Something went wrong. Please try again.", "error");
        return;
      }

      setStatus("Success! Redirecting…", "success");
      window.location.href = "/thanks";
    } catch {
      setStatus("Network error. Please try again.", "error");
    }
  });
</script>

<style>
  /* Component-scoped “beauty” form styling (consistent with your brand variables) */
  .leadmagnet {
    background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.82));
    border: 1px solid rgba(17, 17, 17, 0.10);
    border-radius: 22px;
    padding: 22px;
    box-shadow: 0 18px 50px rgba(0,0,0,0.10);
    backdrop-filter: blur(10px);
  }

  .leadmagnet__copy { margin-bottom: 10px; }

  .field {
    display: grid;
    gap: 6px;
    margin-top: 12px;
  }

  .field__label {
    font-size: 12px;
    letter-spacing: 0.10em;
    text-transform: uppercase;
    color: rgba(17, 17, 17, 0.72);
  }

  .input {
    width: 100%;
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid rgba(17, 17, 17, 0.16);
    background: rgba(255, 255, 255, 0.98);
    color: var(--ink);
    outline: none;
    transition: border-color 140ms ease, box-shadow 140ms ease, background 140ms ease;
  }

  .input::placeholder {
    color: rgba(17, 17, 17, 0.42);
  }

  .input:focus {
    border-color: rgba(107, 63, 38, 0.45);
    box-shadow: 0 0 0 5px rgba(107, 63, 38, 0.14);
    background: #fff;
  }

  /* Fix Chrome autofill “ugly” background + keep text readable */
  .input:-webkit-autofill,
  .input:-webkit-autofill:hover,
  .input:-webkit-autofill:focus {
    -webkit-box-shadow: 0 0 0 1000px rgba(255, 255, 255, 0.98) inset;
    -webkit-text-fill-color: var(--ink);
    transition: background-color 9999s ease-in-out 0s;
  }

  .check {
    display: flex;
    gap: 10px;
    align-items: flex-start;
    margin-top: 12px;
    color: rgba(17, 17, 17, 0.78);
  }

  .check__input {
    margin-top: 3px;
    width: 16px;
    height: 16px;
    accent-color: var(--accent);
  }

  .check__text {
    font-size: 14px;
    line-height: 1.4;
  }

  .hp {
    position: absolute;
    left: -9999px;
    width: 1px;
    height: 1px;
    overflow: hidden;
  }

  .status {
    margin-top: 10px;
    font-size: 13px;
  }

  .status[data-type="info"] { color: rgba(17,17,17,0.70); }
  .status[data-type="success"] { color: rgba(34, 106, 77, 0.92); }
  .status[data-type="error"] { color: rgba(160, 46, 46, 0.95); }

  @media (min-width: 720px) {
    .leadmagnet { padding: 26px; }
  }
</style>
