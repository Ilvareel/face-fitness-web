---
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import CookieBanner from "../components/CookieBanner.astro";

const {
  title = "Face Fitness by Alina",
  description = "A guided face fitness course for women. Natural methods combining tongue posture, breathing and soft tissue work.",
  canonical = "",
  ogImage = "", // optional override per page (absolute URL or /path)
  ogType = "website",
} = Astro.props;

const url = new URL(Astro.request.url);
const canonicalUrl = canonical || url.origin + url.pathname;

// GA4 ID (public env)
const ga4Id = import.meta.env.PUBLIC_GA4_ID ?? "";

// Indexing control (default: OFF until launch)
const allowIndexing = (import.meta.env.PUBLIC_ALLOW_INDEXING ?? "false") === "true";

// Global SEO helper
const siteName = "Face Fitness by Alina";

// Title template:
// - if title already contains a separator (| or •), keep as-is (prevents double branding)
// - if title equals siteName, keep as-is
// - else append " | siteName"
const hasSeparator = typeof title === "string" && (title.includes("|") || title.includes("•"));
const finalTitle =
  !title || title === siteName || hasSeparator ? title : `${title} | ${siteName}`;

// OG image fallback (absolute URL required by most platforms)
const defaultOgImagePath = "/og-default.jpg"; // next step will add this file in /public
const ogImageRaw = ogImage || defaultOgImagePath;
const ogImageUrl = ogImageRaw.startsWith("http")
  ? ogImageRaw
  : new URL(ogImageRaw, url.origin).toString();
---
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{finalTitle}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />

    {!allowIndexing && (
      <>
        <meta name="robots" content="noindex, nofollow" />
        <meta name="googlebot" content="noindex, nofollow" />
      </>
    )}

    <meta property="og:title" content={finalTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content={ogType} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:site_name" content={siteName} />
    <meta property="og:image" content={ogImageUrl} />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={finalTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageUrl} />

    <!-- Fonts (Skinn-like editorial vibe) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&family=Inter:wght@400;500;600&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/styles/global.css" />

    <!-- Consent Mode v2 + GA loader (loads GA only after accept) -->
    <script define:vars={{ ga4Id }}>
      // Simple consent storage key (stable)
      const CONSENT_KEY = "cookie_consent_v1"; // accepted | rejected | null

      // gtag bootstrap (safe even before GA script is loaded)
      window.dataLayer = window.dataLayer || [];
      function gtag(){ window.dataLayer.push(arguments); }
      window.gtag = gtag;

      // Default: denied (Consent Mode v2)
      gtag("consent", "default", {
        ad_storage: "denied",
        analytics_storage: "denied",
        ad_user_data: "denied",
        ad_personalization: "denied",
      });

      function loadGA(){
        if (!ga4Id) return;
        if (window.__gaLoaded) return;
        window.__gaLoaded = true;

        const s = document.createElement("script");
        s.async = true;
        s.src = "https://www.googletagmanager.com/gtag/js?id=" + encodeURIComponent(ga4Id);
        document.head.appendChild(s);

        gtag("js", new Date());
        gtag("config", ga4Id, { anonymize_ip: true });
      }

      // Expose a global function for the banner
      window.__setCookieConsent = function(status){
        try { localStorage.setItem(CONSENT_KEY, status); } catch {}

        if (status === "accepted") {
          gtag("consent", "update", {
            ad_storage: "denied",
            analytics_storage: "granted",
            ad_user_data: "denied",
            ad_personalization: "denied",
          });
          loadGA();
        } else {
          gtag("consent", "update", {
            ad_storage: "denied",
            analytics_storage: "denied",
            ad_user_data: "denied",
            ad_personalization: "denied",
          });
        }

        window.dispatchEvent(new CustomEvent("cookie-consent-updated", { detail: { status } }));
      };

      // On load: apply stored consent
      (function(){
        let status = null;
        try { status = localStorage.getItem(CONSENT_KEY); } catch {}
        if (status === "accepted") window.__setCookieConsent("accepted");
        if (status === "rejected") window.__setCookieConsent("rejected");
      })();
    </script>

    <!-- Event tracking (only sends if GA is loaded) -->
    <script>
      function safeGtagEvent(name, params){
        if (typeof window.gtag !== "function") return;
        if (!window.__gaLoaded) return;
        window.gtag("event", name, params || {});
      }

      // Click tracking via data attributes
      document.addEventListener("click", (e) => {
        const el = e.target && e.target.closest ? e.target.closest("[data-ff-event]") : null;
        if (!el) return;

        const eventName = el.getAttribute("data-ff-event");
        const content = el.getAttribute("data-ff-content") || "";
        const href = el.getAttribute("href") || "";

        safeGtagEvent(eventName, {
          content,
          link_url: href,
        });

        // Special outbound checkout event
        if (el.getAttribute("data-ff-outbound") === "checkout") {
          safeGtagEvent("outbound_checkout", { content, link_url: href });
        }
      });

      // Scroll depth 75% (once)
      let fired75 = false;
      window.addEventListener("scroll", () => {
        if (fired75) return;
        const doc = document.documentElement;
        const scrollTop = window.scrollY || doc.scrollTop || 0;
        const height = (doc.scrollHeight || 0) - (window.innerHeight || 0);
        if (height <= 0) return;
        const pct = scrollTop / height;
        if (pct >= 0.75) {
          fired75 = true;
          safeGtagEvent("scroll_75", { page_path: location.pathname });
        }
      }, { passive: true });
    </script>
  </head>

  <body>
    <a class="skip-link" href="#main">Skip to content</a>

    <Header />

    <main id="main">
      <slot />
    </main>

    <Footer />

    <CookieBanner />
  </body>
</html>